services:
  # Base image service - builds the image once
  mloda-base:
    build:
      context: ..
      dockerfile: .devcontainer/Dockerfile
    image: mloda-devcontainer:latest
    command: "true"  # Exit immediately, just used for building
    networks:
      - dev-network

  ai-agent-1:
    image: mloda-devcontainer:latest
    pull_policy: never
    depends_on:
      mloda-base:
        condition: service_completed_successfully
    volumes:
      - ai_agent_1_data:/workspace
      - ~/.gitconfig:/tmp/host-gitconfig:ro
      - ~/.git-credentials:/tmp/host-git-credentials:ro
    ports:
      - "8000:8000"
    command: >
      bash -c "
        if [ -f /tmp/host-gitconfig ] && [ ! -d /tmp/host-gitconfig ]; then
          cp /tmp/host-gitconfig /home/vscode/.gitconfig;
          echo 'Copied .gitconfig from host';
        fi;
        if [ -f /tmp/host-git-credentials ] && [ ! -d /tmp/host-git-credentials ]; then
          cp /tmp/host-git-credentials /home/vscode/.git-credentials;
          chmod 600 /home/vscode/.git-credentials;
          echo 'Copied .git-credentials from host';
        fi;
        if [ \"$(stat -c '%U' /workspace)\" != 'vscode' ]; then
          echo 'Fixing /workspace ownership (was root)...';
          sudo chown -R vscode:vscode /workspace;
        fi;
        cd /workspace;
        exec bash"
    stdin_open: true    # Keep STDIN open for interaction
    tty: true           # Allocate a pseudo-TTY
    container_name: ai-agent-1
    networks:
      - dev-network

  ai-agent-2:
    image: mloda-devcontainer:latest
    pull_policy: never
    depends_on:
      mloda-base:
        condition: service_completed_successfully
    volumes:
      - ai_agent_2_data:/workspace
      - ~/.gitconfig:/tmp/host-gitconfig:ro
      - ~/.git-credentials:/tmp/host-git-credentials:ro
    ports:
      - "8001:8000"
    command: >
      bash -c "
        if [ -f /tmp/host-gitconfig ] && [ ! -d /tmp/host-gitconfig ]; then
          cp /tmp/host-gitconfig /home/vscode/.gitconfig;
          echo 'Copied .gitconfig from host';
        fi;
        if [ -f /tmp/host-git-credentials ] && [ ! -d /tmp/host-git-credentials ]; then
          cp /tmp/host-git-credentials /home/vscode/.git-credentials;
          chmod 600 /home/vscode/.git-credentials;
          echo 'Copied .git-credentials from host';
        fi;
        if [ \"$(stat -c '%U' /workspace)\" != 'vscode' ]; then
          echo 'Fixing /workspace ownership (was root)...';
          sudo chown -R vscode:vscode /workspace;
        fi;
        cd /workspace;
        exec bash"
    stdin_open: true    # Keep STDIN open for interaction
    tty: true           # Allocate a pseudo-TTY
    container_name: ai-agent-2
    networks:
      - dev-network

  ai-agent-3:
    image: mloda-devcontainer:latest
    pull_policy: never
    depends_on:
      mloda-base:
        condition: service_completed_successfully
    volumes:
      - ai_agent_3_data:/workspace
      - ~/.gitconfig:/tmp/host-gitconfig:ro
      - ~/.git-credentials:/tmp/host-git-credentials:ro
    ports:
      - "8002:8000"
    command: >
      bash -c "
        if [ -f /tmp/host-gitconfig ] && [ ! -d /tmp/host-gitconfig ]; then
          cp /tmp/host-gitconfig /home/vscode/.gitconfig;
          echo 'Copied .gitconfig from host';
        fi;
        if [ -f /tmp/host-git-credentials ] && [ ! -d /tmp/host-git-credentials ]; then
          cp /tmp/host-git-credentials /home/vscode/.git-credentials;
          chmod 600 /home/vscode/.git-credentials;
          echo 'Copied .git-credentials from host';
        fi;
        if [ \"$(stat -c '%U' /workspace)\" != 'vscode' ]; then
          echo 'Fixing /workspace ownership (was root)...';
          sudo chown -R vscode:vscode /workspace;
        fi;
        cd /workspace;
        exec bash"
    stdin_open: true    # Keep STDIN open for interaction
    tty: true           # Allocate a pseudo-TTY
    container_name: ai-agent-3
    networks:
      - dev-network

  ai-agent-4:
    image: mloda-devcontainer:latest
    pull_policy: never
    depends_on:
      mloda-base:
        condition: service_completed_successfully
    volumes:
      - ai_agent_4_data:/workspace
      - ~/.gitconfig:/tmp/host-gitconfig:ro
      - ~/.git-credentials:/tmp/host-git-credentials:ro
    ports:
      - "8003:8000"
    command: >
      bash -c "
        if [ -f /tmp/host-gitconfig ] && [ ! -d /tmp/host-gitconfig ]; then
          cp /tmp/host-gitconfig /home/vscode/.gitconfig;
          echo 'Copied .gitconfig from host';
        fi;
        if [ -f /tmp/host-git-credentials ] && [ ! -d /tmp/host-git-credentials ]; then
          cp /tmp/host-git-credentials /home/vscode/.git-credentials;
          chmod 600 /home/vscode/.git-credentials;
          echo 'Copied .git-credentials from host';
        fi;
        if [ \"$(stat -c '%U' /workspace)\" != 'vscode' ]; then
          echo 'Fixing /workspace ownership (was root)...';
          sudo chown -R vscode:vscode /workspace;
        fi;
        cd /workspace;
        exec bash"
    stdin_open: true    # Keep STDIN open for interaction
    tty: true           # Allocate a pseudo-TTY
    container_name: ai-agent-4
    networks:
      - dev-network

  context7:
    # claude mcp add --transport http context7 http://localhost:8765/mcp
    image: mcp/context7
    ports:
      - "8765:8080"

volumes:
  ai_agent_1_data:
  ai_agent_2_data:
  ai_agent_3_data:
  ai_agent_4_data:

networks:
  dev-network:
    driver: bridge
